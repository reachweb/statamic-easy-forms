<form
    method="{{ method }}"
    action="{{ action }}"
    {{ if wizard }}
    x-data="{
        ...formHandler('{{ handle }}', '{{ form_id }}', {{ if recaptcha_site_key }}'{{ recaptcha_site_key }}'{{ else }}null{{ /if }}, {{ precognition | bool_string }}),
        ...wizardHandler({{ sections | count }})
    }"
    {{ else }}
    x-data="formHandler('{{ handle }}', '{{ form_id }}', {{ if recaptcha_site_key }}'{{ recaptcha_site_key }}'{{ else }}null{{ /if }}, {{ precognition | bool_string }})"
    {{ /if }}
    x-ref="form"
    x-on:submit.prevent="formSubmit"
    x-on:fields-changed="updateSubmitData($event.detail)"
    x-on:validate-field="validateField($event.detail)"
    x-on:grid-row-removed="handleGridRowRemoved($event.detail)"
    data-csrf-token="{{$ csrf_token() $}}"
    aria-label="{{ title }}"
>
    {{# Honeypot field #}}
    {{ if honeypot }}
    <div class="hidden" aria-hidden="true">
        <label for="{{ form_id }}_{{ honeypot }}">{{ honeypot }}</label>
        <input type="text" id="{{ form_id }}_{{ honeypot }}" name="{{ honeypot }}" tabindex="-1" autocomplete="off">
    </div>
    {{ /if }}

    {{# Wizard Progress Indicator #}}
    {{ if wizard }}
    {{ partial:statamic-easy-forms::form/wizard/progress }}
    {{ /if }}
    <div
        x-data="formFields({{ fields | to_json | entities }}, '{{ honeypot }}', {{ hide_fields | to_json | entities ?? '[]' }}, {{ (prepopulated_data | to_json | entities) ?? '[]' }})"
        x-show="! successMessage"
        {{ if wizard }}
        x-init="stepFields = { {{ sections }}{{ step }}: {{ field_handles | to_json | entities }}{{ unless is_last }}, {{ /unless }}{{ /sections }} }"
        {{ /if }}
        class="{{ if wizard }}grid grid-cols-1{{ else }}space-y-6 lg:space-y-10 divide-y divide-ef-border{{ /if }}"
        x-transition.opacity
    >
        {{ if has_sections }}
            {{ sections }}
                {{ if wizard }}
                {{# WIZARD MODE: Steps with visibility toggle #}}
                {{ partial:statamic-easy-forms::form/wizard/wizard_component }}
                {{ else }}
                {{# REGULAR MODE: Fieldsets #}}
                <fieldset class="not-last:pb-6 not-last:lg:pb-10">
                    {{ if display }}
                    <legend class="text-ef-xl font-bold text-ef-label mb-1">{{ display | trans }}</legend>
                    {{ /if }}
                    {{ if instructions }}
                    <p class="text-ef-sm text-ef-text-muted mb-6">{{ instructions | trans }}</p>
                    {{ /if }}

                    <div class="grid grid-cols-12 gap-6 lg:gap-8">
                        {{# Section fields #}}
                        {{ fields }}
                            {{ partial:statamic-easy-forms::form/field_wrapper }}
                        {{ /fields }}
                    </div>
                </fieldset>
                {{ /if }}
            {{ /sections }}
        {{ else }}
            {{# Render fields without sections #}}
            <div class="grid grid-cols-12 gap-6 lg:gap-8">
                {{ fields }}
                    {{ partial:statamic-easy-forms::form/field_wrapper }}
                {{ /fields }}
            </div>
        {{ /if }}
    </div>

    <div class="w-full" x-cloak x-show="! successMessage">
        <div class="my-1 text-center text-ef-error" x-show="fatalError" x-cloak role="alert" aria-live="assertive">
            {{ "There is a technical problem with our form. Please contact us using email." | trans }}
        </div>
        <div class="my-1 text-center text-ef-error" x-show="sessionExpired" x-cloak role="alert" aria-live="assertive">
            {{ "Your session has expired. Please refresh the page and try again." | trans }}
        </div>
        {{# Display reCAPTCHA and other form-level errors #}}
        <div class="my-1 text-center text-ef-error" x-show="'recaptcha' in errors" x-text="errors['recaptcha']" x-cloak role="alert" aria-live="polite"></div>
    </div>

    {{# Wizard Navigation Buttons #}}
    {{ if wizard }}    
    {{ partial:statamic-easy-forms::form/wizard/buttons }}
    {{ else }}
    {{# Regular Submit Button #}}
    <div class="w-full pt-8 xl:pt-12" x-show="! successMessage" x-cloak>
        <button
            class="relative w-full px-6 py-3.5 text-ef-button-text bg-ef-button-bg hover:bg-ef-button-bg-hover focus:ring-4 focus:outline-none font-bold rounded-ef text-ef-lg xl:text-ef-xl focus:ring-ef-focus/20 text-center disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 cursor-pointer"
            type="submit"
            x-bind:disabled="disableSubmit"
            x-bind:aria-busy="disableSubmit"
        >
            <span>{{ submit_text ?? { "Submit" | trans } }}</span>
        </button>
    </div>
    {{ /if }}

    <div class="text-ef-xl text-center my-4 text-ef-text" x-show="successMessage" x-transition.opacity x-cloak role="status" aria-live="polite">
        {{ success_message ?? { "Thank you for your message! We will get back to you shortly!" | trans } }}
    </div>
</form>
