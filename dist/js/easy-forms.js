var EasyForms=(function(c){"use strict";function f(h="formSubmitted",o=null,s=null,a=!1){return{formHandle:h,formId:o||h,recaptchaSiteKey:s,precognitionEnabled:a,submitData:{},errors:{},fatalError:!1,disableSubmit:!1,successMessage:!1,hasReCaptcha:!!s,isSubmitting:!1,precogForm:null,precogInitialized:!1,init(){this.recaptchaSiteKey&&this.loadReCaptcha()},initPrecognition(){if(typeof this.$form!="function"){console.warn("Easy Forms: Precognition is enabled but laravel-precognition-alpine is not loaded."),this.precognitionEnabled=!1;return}this.precogForm=this.$form("post",this.$refs.form.action,this.submitData),this.precogForm.setValidationTimeout(300),this.precogInitialized=!0,this.$watch("precogForm.errors",t=>{this.errors={...t}})},updateSubmitData(t){this.submitData=t,this.precognitionEnabled&&!this.precogInitialized&&this.initPrecognition(),this.precogForm&&Object.keys(t).forEach(r=>{this.precogForm[r]=t[r]})},validateField(t){!this.precognitionEnabled||!this.precogForm||t==="g-recaptcha-response"||t==="recaptcha"||(this.submitData[t]!==void 0&&(this.precogForm[t]=this.submitData[t]),this.precogForm.validate({only:[t]}))},async formSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:submit",{bubbles:!0,detail:{submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}}));try{this.clearErrors(),this.toggleSubmit();let t=null;if(this.recaptchaSiteKey)try{t=await this.getReCaptchaToken()}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:"ReCAPTCHA verification failed. Please refresh the page.",fatalError:!0,formHandle:this.formHandle,formId:this.formId}}));return}const r=this.buildFormData(t),e=await fetch(this.$refs.form.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:r});if(!e.ok){await this.handleErrors(e);return}const i=await e.json();this.handleSuccess(i)}catch(t){this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:t.message,fatalError:!0,formHandle:this.formHandle,formId:this.formId}}))}finally{this.toggleSubmit(),this.isSubmitting=!1}}},buildFormData(t){const r=new FormData;return Object.entries(this.submitData).forEach(([e,i])=>{i instanceof FileList?Array.from(i).forEach(n=>r.append(`${e}[]`,n)):i instanceof File?r.append(e,i):Array.isArray(i)?i.forEach(n=>r.append(`${e}[]`,n)):i!=null&&r.append(e,i)}),r.append("_token",this.$refs.form.dataset.csrfToken),t&&r.append("g-recaptcha-response",t),r},toggleSubmit(){this.disableSubmit=!this.disableSubmit},handleSuccess(t){t.success&&(this.successMessage=!0,this.precognitionEnabled&&this.precogForm&&this.precogForm.reset(),this.$refs.form.dispatchEvent(new CustomEvent("form:success",{bubbles:!0,detail:{data:t,submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}})))},async handleErrors(t){try{if(t.status===500)this.fatalError=!0;else{const r=await t.json();this.errors=r?.error||r?.errors||{},this.precognitionEnabled&&this.precogForm&&this.precogForm.setErrors(this.errors)}this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:this.errors,status:t.status,fatalError:this.fatalError,formHandle:this.formHandle,formId:this.formId}})),this.$nextTick(()=>{this.scrollToFirstError()})}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:{},fatalError:!0,formHandle:this.formHandle,formId:this.formId}}))}},scrollToFirstError(){const t=this.precognitionEnabled&&this.precogForm?this.precogForm.errors:this.errors;if(Object.keys(t).length===0)return;const r=Object.keys(t)[0],e=`${this.formId}_${r}`,i=this.$refs.form.querySelector(`label[for="${e}"]`),n=i?i.closest("div"):this.$refs.form.querySelector(`#${e}`);if(!n)return;const l=n.getBoundingClientRect();l.top>=0&&l.bottom<=window.innerHeight||n.scrollIntoView({behavior:"smooth",block:"center"})},clearErrors(){this.errors={},this.fatalError=!1,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(t=>{this.precogForm.forgetError(t)})},loadReCaptcha(){if(this.recaptchaSiteKey&&!document.querySelector('script[src*="recaptcha"]')){const t=document.createElement("script");t.src=`https://www.google.com/recaptcha/api.js?render=${this.recaptchaSiteKey}`,t.async=!0,t.defer=!0,document.head.appendChild(t)}},getReCaptchaToken(){return new Promise((t,r)=>{if(!this.recaptchaSiteKey){t(null);return}const e=setTimeout(()=>{r(new Error("ReCAPTCHA timeout"))},1e4);let i=0;const n=100,l=()=>{typeof grecaptcha<"u"&&grecaptcha.ready?grecaptcha.ready(()=>{grecaptcha.execute(this.recaptchaSiteKey,{action:"submit"}).then(d=>{clearTimeout(e),t(d)}).catch(d=>{clearTimeout(e),r(d)})}):i++<n?setTimeout(l,100):(clearTimeout(e),r(new Error("ReCAPTCHA failed to load")))};l()})}}}function u(h,o,s,a){return{submitFields:{},fields:[],fieldsMap:{},honeypot:"",init(){this.honeypot=o,this.fields=h.filter(r=>r.input_type!=="hidden").filter(r=>!s.includes(r.handle)),this.submitFields=this.initializeFields(h),this.fieldsMap=h.reduce((r,e)=>(r[e.handle]=e,r),{}),a&&Object.keys(a).length>0&&this.loadPrepopulatedData(a);let t;this.$watch("submitFields",r=>{clearTimeout(t),t=setTimeout(()=>{this.$dispatch("fields-changed",this.submitFields)},100)},{deep:!0}),this.$nextTick(()=>{this.$dispatch("fields-changed",this.submitFields)})},shouldShowField(t){const r=this.fieldsMap[t];if(!r)return!1;try{return typeof window.Statamic>"u"||!window.Statamic?.$conditions?.showField?!0:window.Statamic.$conditions.showField(r,this.submitFields)}catch{return!0}},initializeFields(t){return t.reduce((r,e)=>{let i;return e.type==="assets"?i=null:e.type==="checkboxes"?i=e.default||[]:i=e.default||"",r[e.handle]=i,r},{})},loadPrepopulatedData(t){const r={...this.submitFields};Object.keys(t).forEach(e=>{r.hasOwnProperty(e)&&(r[e]=t[e])}),this.submitFields=r}}}function m(h){return{currentStep:1,totalSteps:h,stepValidating:!1,stepFields:{},async goNext(){this.currentStep>=this.totalSteps||this.stepValidating||await this.validateCurrentStep()&&(this.currentStep++,this.scrollToWizard(),this.dispatchStepChange())},goPrev(){this.currentStep>1&&(this.currentStep--,this.scrollToWizard(),this.dispatchStepChange())},getProgressPercent(){return Math.round(this.currentStep/this.totalSteps*100)},hasFieldError(o){if(this.precogForm&&typeof this.precogForm.invalid=="function")return this.precogForm.invalid(o);const s=this.precogForm?.errors?.[o];return s&&(Array.isArray(s)?s.length>0:!0)},async validateCurrentStep(){const o=Array.from(this.stepFields[this.currentStep]||[]);if(o.length===0)return!0;if(!this.precogForm)return console.warn("Easy Forms Wizard: Precognition is required for wizard validation."),!0;this.stepValidating=!0;try{o.forEach(t=>{this.submitData?.[t]!==void 0&&(this.precogForm[t]=this.submitData[t])}),this.precogForm.validate({only:o});let s=0;for(;!this.precogForm.validating&&s<20;)await new Promise(t=>setTimeout(t,50)),s++;for(;this.precogForm.validating;)await new Promise(t=>setTimeout(t,50));return o.some(t=>this.hasFieldError(t))?(this.scrollToFirstError(o),!1):!0}finally{this.stepValidating=!1}},scrollToFirstError(o){if(!o){const s=this.precogForm?.errors||this.errors||{},a=Object.keys(s);if(a.length===0)return;for(let t=1;t<=this.totalSteps;t++){const r=this.stepFields[t]||[];if(r.some(i=>a.includes(i))){this.currentStep=t,this.dispatchStepChange(),this.$nextTick(()=>{this.scrollToFirstError(r)});return}}return}for(const s of o)if(this.hasFieldError(s)){this.$refs.form?.querySelector(`[name="${s}"], #${s}`)?.scrollIntoView({behavior:"smooth",block:"center"});break}},scrollToWizard(){this.$nextTick(()=>{const o=this.$refs.wizard;if(o){const s=o.getBoundingClientRect();(s.top<0||s.top>window.innerHeight*.3)&&o.scrollIntoView({behavior:"smooth",block:"start"})}})},dispatchStepChange(){this.$refs.form?.dispatchEvent(new CustomEvent("wizard:step-change",{bubbles:!0,detail:{currentStep:this.currentStep,totalSteps:this.totalSteps,formHandle:this.formHandle,formId:this.formId}}))}}}return window.formHandler=f,window.formFields=u,window.wizardHandler=m,c.formFields=u,c.formHandler=f,c.wizardHandler=m,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),c})({});
