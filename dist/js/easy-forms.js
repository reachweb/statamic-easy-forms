var EasyForms=(function(w){"use strict";function _(m="formSubmitted",c=null,a=null,f=!1){return{formHandle:m,formId:c||m,recaptchaSiteKey:a,precognitionEnabled:f,submitData:{},errors:{},fatalError:!1,sessionExpired:!1,disableSubmit:!1,successMessage:!1,hasReCaptcha:!!a,isSubmitting:!1,precogForm:null,precogInitialized:!1,init(){this.recaptchaSiteKey&&this.loadReCaptcha()},initPrecognition(){if(typeof this.$form!="function"){this.precognitionEnabled=!1;return}this.precogForm=this.$form("post",this.$refs.form.action,this.submitData),this.precogForm.setValidationTimeout(300),this.precogInitialized=!0,this.$watch("precogForm.errors",s=>{this.errors={...s}})},updateSubmitData(s){this.submitData=s,this.precognitionEnabled&&!this.precogInitialized&&this.initPrecognition(),this.precogForm&&Object.keys(s).forEach(t=>{this.precogForm[t]=s[t]})},validateField(s){!this.precognitionEnabled||!this.precogForm||s==="g-recaptcha-response"||s==="recaptcha"||/\.\d+\./.test(s)||(this.submitData[s]!==void 0&&(this.precogForm[s]=this.submitData[s]),this.precogForm.validate({only:[s]}))},async formSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:submit",{bubbles:!0,detail:{submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}}));try{this.clearErrors(),this.toggleSubmit();let s=null;if(this.recaptchaSiteKey)try{s=await this.getReCaptchaToken()}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:"ReCAPTCHA verification failed. Please refresh the page.",fatalError:!0,formHandle:this.formHandle,formId:this.formId}}));return}const t=this.buildFormData(s),r=await fetch(this.$refs.form.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:t});if(!r.ok){await this.handleErrors(r);return}const e=await r.json();this.handleSuccess(e)}catch(s){this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:s.message,fatalError:!0,formHandle:this.formHandle,formId:this.formId}}))}finally{this.toggleSubmit(),this.isSubmitting=!1}}},buildFormData(s){const t=new FormData;return Object.entries(this.submitData).forEach(([r,e])=>{if(r.startsWith("_grid_count_"))return;const i=r.includes(".")?r.replace(/\.([^.]+)/g,"[$1]"):r;e instanceof FileList?Array.from(e).forEach(o=>t.append(`${i}[]`,o)):e instanceof File?t.append(i,e):Array.isArray(e)?e.forEach(o=>t.append(`${i}[]`,o)):e!=null&&t.append(i,e)}),t.append("_token",this.$refs.form.dataset.csrfToken),s&&t.append("g-recaptcha-response",s),t},toggleSubmit(){this.disableSubmit=!this.disableSubmit},handleSuccess(s){s.success&&(this.successMessage=!0,this.precognitionEnabled&&this.precogForm&&this.precogForm.reset(),this.$refs.form.dispatchEvent(new CustomEvent("form:success",{bubbles:!0,detail:{data:s,submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}})))},async handleErrors(s){try{if(s.status===419)this.sessionExpired=!0;else if(s.status===500)this.fatalError=!0;else{const t=await s.json(),r=t?.error??t?.errors??{};r&&typeof r=="object"&&!Array.isArray(r)?this.errors=Object.fromEntries(Object.entries(r).map(([e,i])=>[e,Array.isArray(i)?i[0]:i])):r?this.errors={form:String(r)}:this.errors={},this.precognitionEnabled&&this.precogForm&&this.precogForm.setErrors(this.errors)}this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:this.errors,status:s.status,fatalError:this.fatalError,sessionExpired:this.sessionExpired,formHandle:this.formHandle,formId:this.formId}})),this.$nextTick(()=>{this.scrollToFirstError()})}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:{},fatalError:!0,sessionExpired:!1,formHandle:this.formHandle,formId:this.formId}}))}},scrollToFirstError(){const s=this.precognitionEnabled&&this.precogForm?this.precogForm.errors:this.errors;if(Object.keys(s).length===0)return;const r=Object.keys(s)[0].replace(/\./g,"_"),e=`${this.formId}_${r}`,i=this.$refs.form.querySelector(`label[for="${e}"]`),o=i?i.closest("div"):this.$refs.form.querySelector(`#${e}`);if(!o)return;const n=o.getBoundingClientRect();n.top>=0&&n.bottom<=window.innerHeight||o.scrollIntoView({behavior:"smooth",block:"center"})},clearErrors(){this.errors={},this.fatalError=!1,this.sessionExpired=!1,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(s=>{this.precogForm.forgetError(s)})},handleGridRowRemoved({handle:s,removedIndex:t}){const r=new RegExp(`^${s}\\.(\\d+)\\.(.+)$`),e={};for(const[i,o]of Object.entries(this.errors)){const n=i.match(r);if(!n){e[i]=o;continue}const u=parseInt(n[1],10);u<t?e[i]=o:u>t&&(e[`${s}.${u-1}.${n[2]}`]=o)}this.errors=e,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(i=>{i.startsWith(`${s}.`)&&this.precogForm.forgetError(i)})},loadReCaptcha(){if(this.recaptchaSiteKey&&!document.querySelector('script[src*="recaptcha"]')){const s=document.createElement("script");s.src=`https://www.google.com/recaptcha/api.js?render=${this.recaptchaSiteKey}`,s.async=!0,s.defer=!0,document.head.appendChild(s)}},getReCaptchaToken(){return new Promise((s,t)=>{if(!this.recaptchaSiteKey){s(null);return}const r=setTimeout(()=>{t(new Error("ReCAPTCHA timeout"))},1e4);let e=0;const i=100,o=()=>{typeof grecaptcha<"u"&&grecaptcha.ready?grecaptcha.ready(()=>{grecaptcha.execute(this.recaptchaSiteKey,{action:"submit"}).then(n=>{clearTimeout(r),s(n)}).catch(n=>{clearTimeout(r),t(n)})}):e++<i?setTimeout(o,100):(clearTimeout(r),t(new Error("ReCAPTCHA failed to load")))};o()})}}}function F(m,c,a,f,s){return{submitFields:{},fields:[],fieldsMap:{},formId:s||"",honeypot:"",hideFields:[],TRACKING_COOKIE_PREFIX:"ef_track_",COOKIE_EXPIRY_DAYS:30,init(){this.honeypot=c,this.hideFields=a||[],this.captureTrackingParams(),this.fields=m.filter(r=>r.input_type!=="hidden").filter(r=>!a.includes(r.handle)),this.submitFields=this.initializeFields(m),this.fieldsMap=m.reduce((r,e)=>(r[e.handle]=e,e.type==="group"&&e.group_fields&&e.group_fields.forEach(i=>{r[i.field_key]=i}),e.type==="grid"&&e.grid_fields&&e.grid_fields.forEach(i=>{r[`${e.handle}._template_.${i.handle}`]=i}),r),{}),f&&Object.keys(f).length>0&&this.loadPrepopulatedData(f);let t;this.$watch("submitFields",r=>{clearTimeout(t),t=setTimeout(()=>{this.$dispatch("fields-changed",this.submitFields)},100)},{deep:!0}),this.$nextTick(()=>{this.$dispatch("fields-changed",this.submitFields)})},shouldShowField(t){let r=this.fieldsMap[t];if(!r){const e=t.replace(/\.(\d+)\./,"._template_.");r=this.fieldsMap[e]}if(!r||this.hideFields.includes(t))return!1;if(!r.if&&!r.unless&&!r.show_when&&!r.hide_when)return!0;try{return typeof window.Statamic>"u"||!window.Statamic?.$conditions?.showField?!0:window.Statamic.$conditions.showField(r,this.submitFields,t)}catch{return!0}},initializeFields(t){const r=Object.create(null);for(const e of t)r[e.handle]=e.default;return t.reduce((e,i)=>{if(i.type==="group"&&i.group_fields)return i.group_fields.forEach(o=>{const n=`${i.handle}.${o.handle}`;e[n]=this.getFieldDefaultValue(o)}),e;if(i.type==="grid"&&i.grid_fields){let o;if(i.dynamic_rows_field){const n=parseInt(e[i.dynamic_rows_field]??r[i.dynamic_rows_field])||0;o=Math.max(n,i.min_rows||0),i.max_rows&&(o=Math.min(o,i.max_rows))}else o=i.fixed_rows||i.min_rows||1;for(let n=0;n<o;n++)i.grid_fields.forEach(u=>{e[`${i.handle}.${n}.${u.handle}`]=this.getFieldDefaultValue(u)});return e[`_grid_count_${i.handle}`]=o,e}return e[i.handle]=this.getFieldDefaultValue(i),e},{})},getFieldDefaultValue(t){return t.type==="assets"?null:t.type==="toggle"?t.default??!1:t.type==="checkboxes"?t.default||[]:t.handle==="tracking_id"&&t.input_type==="hidden"?this.getTrackingId()||t.default||"":t.default||""},loadPrepopulatedData(t){const r={...this.submitFields};Object.keys(t).forEach(e=>{r.hasOwnProperty(e)&&(r[e]=t[e])}),this.submitFields=r},getTrackingId(){const t=this.getAllTrackingParamsFromUrl(),e={...this.getAllTrackingCookies(),...t};return this.formatTrackingValue(e)},getAllTrackingParamsFromUrl(){const t=this.getTrackedParams(),r=new URLSearchParams(window.location.search),e={};for(const[i,o]of r){const n=i.toLowerCase();t.includes(n)&&o.length<=200&&/^[\w\-_.]+$/.test(o)&&(e[n]=o)}return e},getAllTrackingCookies(){const t={};return this.getTrackedParams().forEach(e=>{const i=this.getCookie(`${this.TRACKING_COOKIE_PREFIX}${e}`);i&&(t[e]=i)}),t},formatTrackingValue(t){const r=Object.entries(t);return r.length===0?"":r.map(([e,i])=>`${encodeURIComponent(e)}=${encodeURIComponent(i)}`).join("&")},getTrackedParams(){const t=["gclid","gbraid","wbraid"],e=this.$el?.closest("form")?.dataset?.trackParams?.split(",").map(i=>i.trim().toLowerCase());return e?.length?e:t},captureTrackingParams(){const t=this.getAllTrackingParamsFromUrl();Object.entries(t).forEach(([r,e])=>{this.setCookie(`${this.TRACKING_COOKIE_PREFIX}${r}`,e,this.COOKIE_EXPIRY_DAYS)})},setCookie(t,r,e){const i=new Date(Date.now()+e*864e5).toUTCString(),o=window.location.protocol==="https:"?"; Secure":"";document.cookie=`${t}=${encodeURIComponent(r)}; expires=${i}; path=/; SameSite=Lax${o}`},getCookie(t){const e=`; ${document.cookie}`.split(`; ${t}=`);return e.length===2?decodeURIComponent(e.pop().split(";").shift()):null},addGridRow(t){const r=this.fieldsMap[t];if(!r?.grid_fields)return;const e=`_grid_count_${t}`,i=this.submitFields[e]||0;r.max_rows&&i>=r.max_rows||(r.grid_fields.forEach(o=>{this.submitFields[`${t}.${i}.${o.handle}`]=this.getFieldDefaultValue(o)}),this.submitFields[e]=i+1,this.cloneGridRow(t,i,!0))},removeGridRow(t,r){const e=this.fieldsMap[t];if(!e?.grid_fields)return;const i=`_grid_count_${t}`,o=this.submitFields[i]||0;if(r=parseInt(r),e.min_rows&&o<=e.min_rows)return;const n=this.formId?`${this.formId}_${t}`:t,d=document.querySelector(`[data-grid-rows="${n}"]`)?.querySelector(`[data-grid-row="${r}"]`),l=()=>{e.grid_fields.forEach(h=>{delete this.submitFields[`${t}.${r}.${h.handle}`]});for(let h=r+1;h<o;h++)e.grid_fields.forEach(p=>{const g=`${t}.${h}.${p.handle}`,E=`${t}.${h-1}.${p.handle}`;this.submitFields[E]=this.submitFields[g],delete this.submitFields[g]});this.submitFields[i]=o-1,this.$dispatch("grid-row-removed",{handle:t,removedIndex:r}),this.rebuildGridRows(t)};d?this.animateGridRowOut(d,l):l()},canAddGridRow(t){const r=this.fieldsMap[t];return!r?.grid_fields||r.is_fixed?!1:r.max_rows?(this.submitFields[`_grid_count_${t}`]||0)<r.max_rows:!0},canRemoveGridRow(t){const r=this.fieldsMap[t];if(!r?.grid_fields||r.is_fixed)return!1;const e=r.min_rows||1;return(this.submitFields[`_grid_count_${t}`]||0)>e},cloneGridRow(t,r,e=!1){const i=this.formId?`${this.formId}_${t}`:t,o=document.querySelector(`[data-grid-template="${i}"]`),n=document.querySelector(`[data-grid-rows="${i}"]`);if(!o||!n)return;const d=o.content.cloneNode(!0).firstElementChild,l=g=>g.replace(/__INDEX__/g,r),h=g=>{const E=[g,...g.querySelectorAll("*")];for(const b of E){for(const $ of Array.from(b.attributes||[]))$.value.includes("__INDEX__")&&b.setAttribute($.name,l($.value));b.tagName==="TEMPLATE"&&b.content&&h(b.content)}};h(d);const p=d.querySelector(".row-number");p&&(p.textContent=r+1),d.setAttribute("data-grid-row",r),e&&(d.classList.add("ef-row-enter"),d.addEventListener("animationend",()=>d.classList.remove("ef-row-enter"),{once:!0})),n.appendChild(d)},rebuildGridRows(t){const r=this.formId?`${this.formId}_${t}`:t,e=document.querySelector(`[data-grid-rows="${r}"]`);if(!e)return;e.innerHTML="";const i=this.submitFields[`_grid_count_${t}`]||0;for(let o=0;o<i;o++)this.cloneGridRow(t,o)},setGridRowCount(t,r){const e=this.fieldsMap[t];if(!e?.grid_fields)return;let i=Math.max(parseInt(r)||0,e.min_rows||0);e.max_rows&&(i=Math.min(i,e.max_rows));const o=`_grid_count_${t}`,n=this.submitFields[o]||0;if(i===n)return;const u=this.formId?`${this.formId}_${t}`:t,d=document.querySelector(`[data-grid-rows="${u}"]`);if(d&&d.querySelectorAll(".ef-row-exit").forEach(l=>l.remove()),i>n)for(let l=n;l<i;l++)e.grid_fields.forEach(h=>{this.submitFields[`${t}.${l}.${h.handle}`]=this.getFieldDefaultValue(h)}),this.cloneGridRow(t,l,!0);else for(let l=n-1;l>=i;l--){e.grid_fields.forEach(p=>{delete this.submitFields[`${t}.${l}.${p.handle}`]});const h=d?.querySelector(`[data-grid-row="${l}"]`);h&&this.animateGridRowOut(h),this.$dispatch("grid-row-removed",{handle:t,removedIndex:l})}this.submitFields[o]=i},animateGridRowOut(t,r){let e=!1;const i=()=>{e||(e=!0,t.remove(),r&&r())};if(window.matchMedia?.("(prefers-reduced-motion: reduce)").matches){i();return}const o=setTimeout(i,400);t.classList.add("ef-row-exit"),t.addEventListener("animationend",()=>{t.style.height=t.offsetHeight+"px",t.style.overflow="hidden",t.offsetHeight,t.style.transition="height .15s ease-in, margin .15s ease-in",t.style.height="0",t.style.marginBottom="0",t.addEventListener("transitionend",()=>{clearTimeout(o),i()},{once:!0})},{once:!0})},initDynamicGridRows(t,r){this.$watch(()=>this.submitFields[r],e=>this.setGridRowCount(t,e)),this.setGridRowCount(t,this.submitFields[r])}}}function y(m){return{currentStep:1,totalSteps:m,stepValidating:!1,stepFields:{},async goNext(){this.currentStep>=this.totalSteps||this.stepValidating||await this.validateCurrentStep()&&(this.currentStep++,this.scrollToWizard(),this.dispatchStepChange())},goPrev(){this.currentStep>1&&(this.currentStep--,this.scrollToWizard(),this.dispatchStepChange())},getProgressPercent(){return Math.round(this.currentStep/this.totalSteps*100)},hasFieldError(c){if(this.precogForm&&typeof this.precogForm.invalid=="function")return this.precogForm.invalid(c);const a=this.precogForm?.errors?.[c];return a&&(Array.isArray(a)?a.length>0:!0)},async validateCurrentStep(){const c=Array.from(this.stepFields[this.currentStep]||[]);if(c.length===0||!this.precogForm)return!0;this.stepValidating=!0;try{c.forEach(s=>{this.submitData?.[s]!==void 0&&(this.precogForm[s]=this.submitData[s])}),this.precogForm.validate({only:c});let a=0;for(;!this.precogForm.validating&&a<20;)await new Promise(s=>setTimeout(s,50)),a++;for(;this.precogForm.validating;)await new Promise(s=>setTimeout(s,50));return c.some(s=>this.hasFieldError(s))?(this.scrollToFirstError(c),!1):!0}finally{this.stepValidating=!1}},scrollToFirstError(c){if(!c){const a=this.precogForm?.errors||this.errors||{},f=Object.keys(a);if(f.length===0)return;for(let s=1;s<=this.totalSteps;s++){const t=this.stepFields[s]||[];if(t.some(e=>f.includes(e))){this.currentStep=s,this.dispatchStepChange(),this.$nextTick(()=>{this.scrollToFirstError(t)});return}}return}for(const a of c)if(this.hasFieldError(a)){this.$refs.form?.querySelector(`[name="${a}"], #${a}`)?.scrollIntoView({behavior:"smooth",block:"center"});break}},scrollToWizard(){this.$nextTick(()=>{const c=this.$refs.wizard;if(c){const a=c.getBoundingClientRect();(a.top<0||a.top>window.innerHeight*.3)&&c.scrollIntoView({behavior:"smooth",block:"start"})}})},dispatchStepChange(){this.$refs.form?.dispatchEvent(new CustomEvent("wizard:step-change",{bubbles:!0,detail:{currentStep:this.currentStep,totalSteps:this.totalSteps,formHandle:this.formHandle,formId:this.formId}}))}}}return window.formHandler=_,window.formFields=F,window.wizardHandler=y,w.formFields=F,w.formHandler=_,w.wizardHandler=y,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"}),w})({});
