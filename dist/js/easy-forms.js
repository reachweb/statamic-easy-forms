var EasyForms=(function(u){"use strict";function w(d="formSubmitted",c=null,a=null,h=!1){return{formHandle:d,formId:c||d,recaptchaSiteKey:a,precognitionEnabled:h,submitData:{},errors:{},fatalError:!1,sessionExpired:!1,disableSubmit:!1,successMessage:!1,hasReCaptcha:!!a,isSubmitting:!1,precogForm:null,precogInitialized:!1,init(){this.recaptchaSiteKey&&this.loadReCaptcha()},initPrecognition(){if(typeof this.$form!="function"){this.precognitionEnabled=!1;return}this.precogForm=this.$form("post",this.$refs.form.action,this.submitData),this.precogForm.setValidationTimeout(300),this.precogInitialized=!0,this.$watch("precogForm.errors",s=>{this.errors={...s}})},updateSubmitData(s){this.submitData=s,this.precognitionEnabled&&!this.precogInitialized&&this.initPrecognition(),this.precogForm&&Object.keys(s).forEach(r=>{this.precogForm[r]=s[r]})},validateField(s){!this.precognitionEnabled||!this.precogForm||s==="g-recaptcha-response"||s==="recaptcha"||/\.\d+\./.test(s)||(this.submitData[s]!==void 0&&(this.precogForm[s]=this.submitData[s]),this.precogForm.validate({only:[s]}))},async formSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:submit",{bubbles:!0,detail:{submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}}));try{this.clearErrors(),this.toggleSubmit();let s=null;if(this.recaptchaSiteKey)try{s=await this.getReCaptchaToken()}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:"ReCAPTCHA verification failed. Please refresh the page.",fatalError:!0,formHandle:this.formHandle,formId:this.formId}}));return}const r=this.buildFormData(s),t=await fetch(this.$refs.form.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:r});if(!t.ok){await this.handleErrors(t);return}const e=await t.json();this.handleSuccess(e)}catch(s){this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:s.message,fatalError:!0,formHandle:this.formHandle,formId:this.formId}}))}finally{this.toggleSubmit(),this.isSubmitting=!1}}},buildFormData(s){const r=new FormData;return Object.entries(this.submitData).forEach(([t,e])=>{if(t.startsWith("_grid_count_"))return;const i=t.includes(".")?t.replace(/\.([^.]+)/g,"[$1]"):t;e instanceof FileList?Array.from(e).forEach(o=>r.append(`${i}[]`,o)):e instanceof File?r.append(i,e):Array.isArray(e)?e.forEach(o=>r.append(`${i}[]`,o)):e!=null&&r.append(i,e)}),r.append("_token",this.$refs.form.dataset.csrfToken),s&&r.append("g-recaptcha-response",s),r},toggleSubmit(){this.disableSubmit=!this.disableSubmit},handleSuccess(s){s.success&&(this.successMessage=!0,this.precognitionEnabled&&this.precogForm&&this.precogForm.reset(),this.$refs.form.dispatchEvent(new CustomEvent("form:success",{bubbles:!0,detail:{data:s,submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}})))},async handleErrors(s){try{if(s.status===419)this.sessionExpired=!0;else if(s.status===500)this.fatalError=!0;else{const r=await s.json(),t=r?.error??r?.errors??{};t&&typeof t=="object"&&!Array.isArray(t)?this.errors=Object.fromEntries(Object.entries(t).map(([e,i])=>[e,Array.isArray(i)?i[0]:i])):t?this.errors={form:String(t)}:this.errors={},this.precognitionEnabled&&this.precogForm&&this.precogForm.setErrors(this.errors)}this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:this.errors,status:s.status,fatalError:this.fatalError,sessionExpired:this.sessionExpired,formHandle:this.formHandle,formId:this.formId}})),this.$nextTick(()=>{this.scrollToFirstError()})}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:{},fatalError:!0,sessionExpired:!1,formHandle:this.formHandle,formId:this.formId}}))}},scrollToFirstError(){const s=this.precognitionEnabled&&this.precogForm?this.precogForm.errors:this.errors;if(Object.keys(s).length===0)return;const t=Object.keys(s)[0].replace(/\./g,"_"),e=`${this.formId}_${t}`,i=this.$refs.form.querySelector(`label[for="${e}"]`),o=i?i.closest("div"):this.$refs.form.querySelector(`#${e}`);if(!o)return;const n=o.getBoundingClientRect();n.top>=0&&n.bottom<=window.innerHeight||o.scrollIntoView({behavior:"smooth",block:"center"})},clearErrors(){this.errors={},this.fatalError=!1,this.sessionExpired=!1,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(s=>{this.precogForm.forgetError(s)})},handleGridRowRemoved({handle:s,removedIndex:r}){const t=new RegExp(`^${s}\\.(\\d+)\\.(.+)$`),e={};for(const[i,o]of Object.entries(this.errors)){const n=i.match(t);if(!n){e[i]=o;continue}const l=parseInt(n[1],10);l<r?e[i]=o:l>r&&(e[`${s}.${l-1}.${n[2]}`]=o)}this.errors=e,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(i=>{i.startsWith(`${s}.`)&&this.precogForm.forgetError(i)})},loadReCaptcha(){if(this.recaptchaSiteKey&&!document.querySelector('script[src*="recaptcha"]')){const s=document.createElement("script");s.src=`https://www.google.com/recaptcha/api.js?render=${this.recaptchaSiteKey}`,s.async=!0,s.defer=!0,document.head.appendChild(s)}},getReCaptchaToken(){return new Promise((s,r)=>{if(!this.recaptchaSiteKey){s(null);return}const t=setTimeout(()=>{r(new Error("ReCAPTCHA timeout"))},1e4);let e=0;const i=100,o=()=>{typeof grecaptcha<"u"&&grecaptcha.ready?grecaptcha.ready(()=>{grecaptcha.execute(this.recaptchaSiteKey,{action:"submit"}).then(n=>{clearTimeout(t),s(n)}).catch(n=>{clearTimeout(t),r(n)})}):e++<i?setTimeout(o,100):(clearTimeout(t),r(new Error("ReCAPTCHA failed to load")))};o()})}}}function E(d,c,a,h,s){return{submitFields:{},fields:[],fieldsMap:{},formId:s||"",honeypot:"",hideFields:[],TRACKING_COOKIE_PREFIX:"ef_track_",COOKIE_EXPIRY_DAYS:30,init(){this.honeypot=c,this.hideFields=a||[],this.captureTrackingParams(),this.fields=d.filter(t=>t.input_type!=="hidden").filter(t=>!a.includes(t.handle)),this.submitFields=this.initializeFields(d),this.fieldsMap=d.reduce((t,e)=>(t[e.handle]=e,e.type==="group"&&e.group_fields&&e.group_fields.forEach(i=>{t[i.field_key]=i}),e.type==="grid"&&e.grid_fields&&e.grid_fields.forEach(i=>{t[`${e.handle}._template_.${i.handle}`]=i}),t),{}),h&&Object.keys(h).length>0&&this.loadPrepopulatedData(h);let r;this.$watch("submitFields",t=>{clearTimeout(r),r=setTimeout(()=>{this.$dispatch("fields-changed",this.submitFields)},100)},{deep:!0}),this.$nextTick(()=>{this.$dispatch("fields-changed",this.submitFields)})},shouldShowField(r){let t=this.fieldsMap[r];if(!t){const e=r.replace(/\.(\d+)\./,"._template_.");t=this.fieldsMap[e]}if(!t||this.hideFields.includes(r))return!1;if(!t.if&&!t.unless&&!t.show_when&&!t.hide_when)return!0;try{return typeof window.Statamic>"u"||!window.Statamic?.$conditions?.showField?!0:window.Statamic.$conditions.showField(t,this.submitFields,r)}catch{return!0}},initializeFields(r){return r.reduce((t,e)=>{if(e.type==="group"&&e.group_fields)return e.group_fields.forEach(i=>{const o=`${e.handle}.${i.handle}`;t[o]=this.getFieldDefaultValue(i)}),t;if(e.type==="grid"&&e.grid_fields){let i;if(e.dynamic_rows_field){const o=parseInt(t[e.dynamic_rows_field])||0;i=Math.max(o,e.min_rows||0),e.max_rows&&(i=Math.min(i,e.max_rows))}else i=e.fixed_rows||e.min_rows||1;for(let o=0;o<i;o++)e.grid_fields.forEach(n=>{t[`${e.handle}.${o}.${n.handle}`]=this.getFieldDefaultValue(n)});return t[`_grid_count_${e.handle}`]=i,t}return t[e.handle]=this.getFieldDefaultValue(e),t},{})},getFieldDefaultValue(r){return r.type==="assets"?null:r.type==="toggle"?r.default??!1:r.type==="checkboxes"?r.default||[]:r.handle==="tracking_id"&&r.input_type==="hidden"?this.getTrackingId()||r.default||"":r.default||""},loadPrepopulatedData(r){const t={...this.submitFields};Object.keys(r).forEach(e=>{t.hasOwnProperty(e)&&(t[e]=r[e])}),this.submitFields=t},getTrackingId(){const r=this.getAllTrackingParamsFromUrl(),e={...this.getAllTrackingCookies(),...r};return this.formatTrackingValue(e)},getAllTrackingParamsFromUrl(){const r=this.getTrackedParams(),t=new URLSearchParams(window.location.search),e={};for(const[i,o]of t){const n=i.toLowerCase();r.includes(n)&&o.length<=200&&/^[\w\-_.]+$/.test(o)&&(e[n]=o)}return e},getAllTrackingCookies(){const r={};return this.getTrackedParams().forEach(e=>{const i=this.getCookie(`${this.TRACKING_COOKIE_PREFIX}${e}`);i&&(r[e]=i)}),r},formatTrackingValue(r){const t=Object.entries(r);return t.length===0?"":t.map(([e,i])=>`${encodeURIComponent(e)}=${encodeURIComponent(i)}`).join("&")},getTrackedParams(){const r=["gclid","gbraid","wbraid"],e=this.$el?.closest("form")?.dataset?.trackParams?.split(",").map(i=>i.trim().toLowerCase());return e?.length?e:r},captureTrackingParams(){const r=this.getAllTrackingParamsFromUrl();Object.entries(r).forEach(([t,e])=>{this.setCookie(`${this.TRACKING_COOKIE_PREFIX}${t}`,e,this.COOKIE_EXPIRY_DAYS)})},setCookie(r,t,e){const i=new Date(Date.now()+e*864e5).toUTCString(),o=window.location.protocol==="https:"?"; Secure":"";document.cookie=`${r}=${encodeURIComponent(t)}; expires=${i}; path=/; SameSite=Lax${o}`},getCookie(r){const e=`; ${document.cookie}`.split(`; ${r}=`);return e.length===2?decodeURIComponent(e.pop().split(";").shift()):null},addGridRow(r){const t=this.fieldsMap[r];if(!t?.grid_fields)return;const e=`_grid_count_${r}`,i=this.submitFields[e]||0;t.max_rows&&i>=t.max_rows||(t.grid_fields.forEach(o=>{this.submitFields[`${r}.${i}.${o.handle}`]=this.getFieldDefaultValue(o)}),this.submitFields[e]=i+1,this.cloneGridRow(r,i))},removeGridRow(r,t){const e=this.fieldsMap[r];if(!e?.grid_fields)return;const i=`_grid_count_${r}`,o=this.submitFields[i]||0;if(t=parseInt(t),!(e.min_rows&&o<=e.min_rows)){e.grid_fields.forEach(n=>{delete this.submitFields[`${r}.${t}.${n.handle}`]});for(let n=t+1;n<o;n++)e.grid_fields.forEach(l=>{const m=`${r}.${n}.${l.handle}`,p=`${r}.${n-1}.${l.handle}`;this.submitFields[p]=this.submitFields[m],delete this.submitFields[m]});this.submitFields[i]=o-1,this.$dispatch("grid-row-removed",{handle:r,removedIndex:t}),this.rebuildGridRows(r)}},canAddGridRow(r){const t=this.fieldsMap[r];return!t?.grid_fields||t.is_fixed?!1:t.max_rows?(this.submitFields[`_grid_count_${r}`]||0)<t.max_rows:!0},canRemoveGridRow(r){const t=this.fieldsMap[r];if(!t?.grid_fields||t.is_fixed)return!1;const e=t.min_rows||1;return(this.submitFields[`_grid_count_${r}`]||0)>e},cloneGridRow(r,t){const e=this.formId?`${this.formId}_${r}`:r,i=document.querySelector(`[data-grid-template="${e}"]`),o=document.querySelector(`[data-grid-rows="${e}"]`);if(!i||!o)return;const l=i.content.cloneNode(!0).firstElementChild,m=g=>g.replace(/__INDEX__/g,t),p=g=>{const $=[g,...g.querySelectorAll("*")];for(const f of $){for(const b of Array.from(f.attributes||[]))b.value.includes("__INDEX__")&&f.setAttribute(b.name,m(b.value));f.tagName==="TEMPLATE"&&f.content&&p(f.content)}};p(l);const F=l.querySelector(".row-number");F&&(F.textContent=t+1),l.setAttribute("data-grid-row",t),o.appendChild(l)},rebuildGridRows(r){const t=this.formId?`${this.formId}_${r}`:r,e=document.querySelector(`[data-grid-rows="${t}"]`);if(!e)return;e.innerHTML="";const i=this.submitFields[`_grid_count_${r}`]||0;for(let o=0;o<i;o++)this.cloneGridRow(r,o)},setGridRowCount(r,t){const e=this.fieldsMap[r];if(!e?.grid_fields)return;t=parseInt(t)||0,t=Math.max(t,e.min_rows||0),e.max_rows&&(t=Math.min(t,e.max_rows));const i=`_grid_count_${r}`,o=this.submitFields[i]||0;if(t!==o){if(t>o)for(let n=o;n<t;n++)e.grid_fields.forEach(l=>{this.submitFields[`${r}.${n}.${l.handle}`]=this.getFieldDefaultValue(l)});else for(let n=o-1;n>=t;n--)e.grid_fields.forEach(l=>{delete this.submitFields[`${r}.${n}.${l.handle}`]});this.submitFields[i]=t,this.rebuildGridRows(r)}},initDynamicGridRows(r,t){this.$watch(()=>this.submitFields[t],e=>{this.setGridRowCount(r,e)})}}}function _(d){return{currentStep:1,totalSteps:d,stepValidating:!1,stepFields:{},async goNext(){this.currentStep>=this.totalSteps||this.stepValidating||await this.validateCurrentStep()&&(this.currentStep++,this.scrollToWizard(),this.dispatchStepChange())},goPrev(){this.currentStep>1&&(this.currentStep--,this.scrollToWizard(),this.dispatchStepChange())},getProgressPercent(){return Math.round(this.currentStep/this.totalSteps*100)},hasFieldError(c){if(this.precogForm&&typeof this.precogForm.invalid=="function")return this.precogForm.invalid(c);const a=this.precogForm?.errors?.[c];return a&&(Array.isArray(a)?a.length>0:!0)},async validateCurrentStep(){const c=Array.from(this.stepFields[this.currentStep]||[]);if(c.length===0||!this.precogForm)return!0;this.stepValidating=!0;try{c.forEach(s=>{this.submitData?.[s]!==void 0&&(this.precogForm[s]=this.submitData[s])}),this.precogForm.validate({only:c});let a=0;for(;!this.precogForm.validating&&a<20;)await new Promise(s=>setTimeout(s,50)),a++;for(;this.precogForm.validating;)await new Promise(s=>setTimeout(s,50));return c.some(s=>this.hasFieldError(s))?(this.scrollToFirstError(c),!1):!0}finally{this.stepValidating=!1}},scrollToFirstError(c){if(!c){const a=this.precogForm?.errors||this.errors||{},h=Object.keys(a);if(h.length===0)return;for(let s=1;s<=this.totalSteps;s++){const r=this.stepFields[s]||[];if(r.some(e=>h.includes(e))){this.currentStep=s,this.dispatchStepChange(),this.$nextTick(()=>{this.scrollToFirstError(r)});return}}return}for(const a of c)if(this.hasFieldError(a)){this.$refs.form?.querySelector(`[name="${a}"], #${a}`)?.scrollIntoView({behavior:"smooth",block:"center"});break}},scrollToWizard(){this.$nextTick(()=>{const c=this.$refs.wizard;if(c){const a=c.getBoundingClientRect();(a.top<0||a.top>window.innerHeight*.3)&&c.scrollIntoView({behavior:"smooth",block:"start"})}})},dispatchStepChange(){this.$refs.form?.dispatchEvent(new CustomEvent("wizard:step-change",{bubbles:!0,detail:{currentStep:this.currentStep,totalSteps:this.totalSteps,formHandle:this.formHandle,formId:this.formId}}))}}}return window.formHandler=w,window.formFields=E,window.wizardHandler=_,u.formFields=E,u.formHandler=w,u.wizardHandler=_,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),u})({});
