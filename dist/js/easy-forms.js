var EasyForms=(function(u){"use strict";function w(d="formSubmitted",c=null,a=null,h=!1){return{formHandle:d,formId:c||d,recaptchaSiteKey:a,precognitionEnabled:h,submitData:{},errors:{},fatalError:!1,sessionExpired:!1,disableSubmit:!1,successMessage:!1,hasReCaptcha:!!a,isSubmitting:!1,precogForm:null,precogInitialized:!1,init(){this.recaptchaSiteKey&&this.loadReCaptcha()},initPrecognition(){if(typeof this.$form!="function"){this.precognitionEnabled=!1;return}this.precogForm=this.$form("post",this.$refs.form.action,this.submitData),this.precogForm.setValidationTimeout(300),this.precogInitialized=!0,this.$watch("precogForm.errors",i=>{this.errors={...i}})},updateSubmitData(i){this.submitData=i,this.precognitionEnabled&&!this.precogInitialized&&this.initPrecognition(),this.precogForm&&Object.keys(i).forEach(t=>{this.precogForm[t]=i[t]})},validateField(i){!this.precognitionEnabled||!this.precogForm||i==="g-recaptcha-response"||i==="recaptcha"||/\.\d+\./.test(i)||(this.submitData[i]!==void 0&&(this.precogForm[i]=this.submitData[i]),this.precogForm.validate({only:[i]}))},async formSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:submit",{bubbles:!0,detail:{submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}}));try{this.clearErrors(),this.toggleSubmit();let i=null;if(this.recaptchaSiteKey)try{i=await this.getReCaptchaToken()}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:"ReCAPTCHA verification failed. Please refresh the page.",fatalError:!0,formHandle:this.formHandle,formId:this.formId}}));return}const t=this.buildFormData(i),e=await fetch(this.$refs.form.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:t});if(!e.ok){await this.handleErrors(e);return}const r=await e.json();this.handleSuccess(r)}catch(i){this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:i.message,fatalError:!0,formHandle:this.formHandle,formId:this.formId}}))}finally{this.toggleSubmit(),this.isSubmitting=!1}}},buildFormData(i){const t=new FormData;return Object.entries(this.submitData).forEach(([e,r])=>{if(e.startsWith("_grid_count_"))return;const s=e.includes(".")?e.replace(/\.([^.]+)/g,"[$1]"):e;r instanceof FileList?Array.from(r).forEach(o=>t.append(`${s}[]`,o)):r instanceof File?t.append(s,r):Array.isArray(r)?r.forEach(o=>t.append(`${s}[]`,o)):r!=null&&t.append(s,r)}),t.append("_token",this.$refs.form.dataset.csrfToken),i&&t.append("g-recaptcha-response",i),t},toggleSubmit(){this.disableSubmit=!this.disableSubmit},handleSuccess(i){i.success&&(this.successMessage=!0,this.precognitionEnabled&&this.precogForm&&this.precogForm.reset(),this.$refs.form.dispatchEvent(new CustomEvent("form:success",{bubbles:!0,detail:{data:i,submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}})))},async handleErrors(i){try{if(i.status===419)this.sessionExpired=!0;else if(i.status===500)this.fatalError=!0;else{const t=await i.json(),e=t?.error??t?.errors??{};e&&typeof e=="object"&&!Array.isArray(e)?this.errors=Object.fromEntries(Object.entries(e).map(([r,s])=>[r,Array.isArray(s)?s[0]:s])):e?this.errors={form:String(e)}:this.errors={},this.precognitionEnabled&&this.precogForm&&this.precogForm.setErrors(this.errors)}this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:this.errors,status:i.status,fatalError:this.fatalError,sessionExpired:this.sessionExpired,formHandle:this.formHandle,formId:this.formId}})),this.$nextTick(()=>{this.scrollToFirstError()})}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:{},fatalError:!0,sessionExpired:!1,formHandle:this.formHandle,formId:this.formId}}))}},scrollToFirstError(){const i=this.precognitionEnabled&&this.precogForm?this.precogForm.errors:this.errors;if(Object.keys(i).length===0)return;const e=Object.keys(i)[0].replace(/\./g,"_"),r=`${this.formId}_${e}`,s=this.$refs.form.querySelector(`label[for="${r}"]`),o=s?s.closest("div"):this.$refs.form.querySelector(`#${r}`);if(!o)return;const n=o.getBoundingClientRect();n.top>=0&&n.bottom<=window.innerHeight||o.scrollIntoView({behavior:"smooth",block:"center"})},clearErrors(){this.errors={},this.fatalError=!1,this.sessionExpired=!1,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(i=>{this.precogForm.forgetError(i)})},handleGridRowRemoved({handle:i,removedIndex:t}){const e=new RegExp(`^${i}\\.(\\d+)\\.(.+)$`),r={};for(const[s,o]of Object.entries(this.errors)){const n=s.match(e);if(!n){r[s]=o;continue}const l=parseInt(n[1],10);l<t?r[s]=o:l>t&&(r[`${i}.${l-1}.${n[2]}`]=o)}this.errors=r,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(s=>{s.startsWith(`${i}.`)&&this.precogForm.forgetError(s)})},loadReCaptcha(){if(this.recaptchaSiteKey&&!document.querySelector('script[src*="recaptcha"]')){const i=document.createElement("script");i.src=`https://www.google.com/recaptcha/api.js?render=${this.recaptchaSiteKey}`,i.async=!0,i.defer=!0,document.head.appendChild(i)}},getReCaptchaToken(){return new Promise((i,t)=>{if(!this.recaptchaSiteKey){i(null);return}const e=setTimeout(()=>{t(new Error("ReCAPTCHA timeout"))},1e4);let r=0;const s=100,o=()=>{typeof grecaptcha<"u"&&grecaptcha.ready?grecaptcha.ready(()=>{grecaptcha.execute(this.recaptchaSiteKey,{action:"submit"}).then(n=>{clearTimeout(e),i(n)}).catch(n=>{clearTimeout(e),t(n)})}):r++<s?setTimeout(o,100):(clearTimeout(e),t(new Error("ReCAPTCHA failed to load")))};o()})}}}function E(d,c,a,h,i){return{submitFields:{},fields:[],fieldsMap:{},formId:i||"",honeypot:"",hideFields:[],TRACKING_COOKIE_PREFIX:"ef_track_",COOKIE_EXPIRY_DAYS:30,init(){this.honeypot=c,this.hideFields=a||[],this.captureTrackingParams(),this.fields=d.filter(e=>e.input_type!=="hidden").filter(e=>!a.includes(e.handle)),this.submitFields=this.initializeFields(d),this.fieldsMap=d.reduce((e,r)=>(e[r.handle]=r,r.type==="group"&&r.group_fields&&r.group_fields.forEach(s=>{e[s.field_key]=s}),r.type==="grid"&&r.grid_fields&&r.grid_fields.forEach(s=>{e[`${r.handle}._template_.${s.handle}`]=s}),e),{}),h&&Object.keys(h).length>0&&this.loadPrepopulatedData(h);let t;this.$watch("submitFields",e=>{clearTimeout(t),t=setTimeout(()=>{this.$dispatch("fields-changed",this.submitFields)},100)},{deep:!0}),this.$nextTick(()=>{this.$dispatch("fields-changed",this.submitFields)})},shouldShowField(t){let e=this.fieldsMap[t];if(!e){const r=t.replace(/\.(\d+)\./,"._template_.");e=this.fieldsMap[r]}if(!e||this.hideFields.includes(t))return!1;if(!e.if&&!e.unless&&!e.show_when&&!e.hide_when)return!0;try{return typeof window.Statamic>"u"||!window.Statamic?.$conditions?.showField?!0:window.Statamic.$conditions.showField(e,this.submitFields,t)}catch{return!0}},initializeFields(t){return t.reduce((e,r)=>{if(r.type==="group"&&r.group_fields)return r.group_fields.forEach(s=>{const o=`${r.handle}.${s.handle}`;e[o]=this.getFieldDefaultValue(s)}),e;if(r.type==="grid"&&r.grid_fields){const s=r.fixed_rows||r.min_rows||1;for(let o=0;o<s;o++)r.grid_fields.forEach(n=>{e[`${r.handle}.${o}.${n.handle}`]=this.getFieldDefaultValue(n)});return e[`_grid_count_${r.handle}`]=s,e}return e[r.handle]=this.getFieldDefaultValue(r),e},{})},getFieldDefaultValue(t){return t.type==="assets"?null:t.type==="toggle"?t.default??!1:t.type==="checkboxes"?t.default||[]:t.handle==="tracking_id"&&t.input_type==="hidden"?this.getTrackingId()||t.default||"":t.default||""},loadPrepopulatedData(t){const e={...this.submitFields};Object.keys(t).forEach(r=>{e.hasOwnProperty(r)&&(e[r]=t[r])}),this.submitFields=e},getTrackingId(){const t=this.getAllTrackingParamsFromUrl(),r={...this.getAllTrackingCookies(),...t};return this.formatTrackingValue(r)},getAllTrackingParamsFromUrl(){const t=this.getTrackedParams(),e=new URLSearchParams(window.location.search),r={};for(const[s,o]of e){const n=s.toLowerCase();t.includes(n)&&o.length<=200&&/^[\w\-_.]+$/.test(o)&&(r[n]=o)}return r},getAllTrackingCookies(){const t={};return this.getTrackedParams().forEach(r=>{const s=this.getCookie(`${this.TRACKING_COOKIE_PREFIX}${r}`);s&&(t[r]=s)}),t},formatTrackingValue(t){const e=Object.entries(t);return e.length===0?"":e.map(([r,s])=>`${encodeURIComponent(r)}=${encodeURIComponent(s)}`).join("&")},getTrackedParams(){const t=["gclid","gbraid","wbraid"],r=this.$el?.closest("form")?.dataset?.trackParams?.split(",").map(s=>s.trim().toLowerCase());return r?.length?r:t},captureTrackingParams(){const t=this.getAllTrackingParamsFromUrl();Object.entries(t).forEach(([e,r])=>{this.setCookie(`${this.TRACKING_COOKIE_PREFIX}${e}`,r,this.COOKIE_EXPIRY_DAYS)})},setCookie(t,e,r){const s=new Date(Date.now()+r*864e5).toUTCString(),o=window.location.protocol==="https:"?"; Secure":"";document.cookie=`${t}=${encodeURIComponent(e)}; expires=${s}; path=/; SameSite=Lax${o}`},getCookie(t){const r=`; ${document.cookie}`.split(`; ${t}=`);return r.length===2?decodeURIComponent(r.pop().split(";").shift()):null},addGridRow(t){const e=this.fieldsMap[t];if(!e?.grid_fields)return;const r=`_grid_count_${t}`,s=this.submitFields[r]||0;e.max_rows&&s>=e.max_rows||(e.grid_fields.forEach(o=>{this.submitFields[`${t}.${s}.${o.handle}`]=this.getFieldDefaultValue(o)}),this.submitFields[r]=s+1,this.cloneGridRow(t,s))},removeGridRow(t,e){const r=this.fieldsMap[t];if(!r?.grid_fields)return;const s=`_grid_count_${t}`,o=this.submitFields[s]||0;if(e=parseInt(e),!(r.min_rows&&o<=r.min_rows)){r.grid_fields.forEach(n=>{delete this.submitFields[`${t}.${e}.${n.handle}`]});for(let n=e+1;n<o;n++)r.grid_fields.forEach(l=>{const m=`${t}.${n}.${l.handle}`,p=`${t}.${n-1}.${l.handle}`;this.submitFields[p]=this.submitFields[m],delete this.submitFields[m]});this.submitFields[s]=o-1,this.$dispatch("grid-row-removed",{handle:t,removedIndex:e}),this.rebuildGridRows(t)}},canAddGridRow(t){const e=this.fieldsMap[t];return!e?.grid_fields||e.is_fixed?!1:e.max_rows?(this.submitFields[`_grid_count_${t}`]||0)<e.max_rows:!0},canRemoveGridRow(t){const e=this.fieldsMap[t];if(!e?.grid_fields||e.is_fixed)return!1;const r=e.min_rows||1;return(this.submitFields[`_grid_count_${t}`]||0)>r},cloneGridRow(t,e){const r=this.formId?`${this.formId}_${t}`:t,s=document.querySelector(`[data-grid-template="${r}"]`),o=document.querySelector(`[data-grid-rows="${r}"]`);if(!s||!o)return;const l=s.content.cloneNode(!0).firstElementChild,m=g=>g.replace(/__INDEX__/g,e),p=g=>{const _=[g,...g.querySelectorAll("*")];for(const f of _){for(const b of Array.from(f.attributes||[]))b.value.includes("__INDEX__")&&f.setAttribute(b.name,m(b.value));f.tagName==="TEMPLATE"&&f.content&&p(f.content)}};p(l);const $=l.querySelector(".row-number");$&&($.textContent=e+1),l.setAttribute("data-grid-row",e),o.appendChild(l)},rebuildGridRows(t){const e=this.formId?`${this.formId}_${t}`:t,r=document.querySelector(`[data-grid-rows="${e}"]`);if(!r)return;r.innerHTML="";const s=this.submitFields[`_grid_count_${t}`]||0;for(let o=0;o<s;o++)this.cloneGridRow(t,o)}}}function F(d){return{currentStep:1,totalSteps:d,stepValidating:!1,stepFields:{},async goNext(){this.currentStep>=this.totalSteps||this.stepValidating||await this.validateCurrentStep()&&(this.currentStep++,this.scrollToWizard(),this.dispatchStepChange())},goPrev(){this.currentStep>1&&(this.currentStep--,this.scrollToWizard(),this.dispatchStepChange())},getProgressPercent(){return Math.round(this.currentStep/this.totalSteps*100)},hasFieldError(c){if(this.precogForm&&typeof this.precogForm.invalid=="function")return this.precogForm.invalid(c);const a=this.precogForm?.errors?.[c];return a&&(Array.isArray(a)?a.length>0:!0)},async validateCurrentStep(){const c=Array.from(this.stepFields[this.currentStep]||[]);if(c.length===0||!this.precogForm)return!0;this.stepValidating=!0;try{c.forEach(i=>{this.submitData?.[i]!==void 0&&(this.precogForm[i]=this.submitData[i])}),this.precogForm.validate({only:c});let a=0;for(;!this.precogForm.validating&&a<20;)await new Promise(i=>setTimeout(i,50)),a++;for(;this.precogForm.validating;)await new Promise(i=>setTimeout(i,50));return c.some(i=>this.hasFieldError(i))?(this.scrollToFirstError(c),!1):!0}finally{this.stepValidating=!1}},scrollToFirstError(c){if(!c){const a=this.precogForm?.errors||this.errors||{},h=Object.keys(a);if(h.length===0)return;for(let i=1;i<=this.totalSteps;i++){const t=this.stepFields[i]||[];if(t.some(r=>h.includes(r))){this.currentStep=i,this.dispatchStepChange(),this.$nextTick(()=>{this.scrollToFirstError(t)});return}}return}for(const a of c)if(this.hasFieldError(a)){this.$refs.form?.querySelector(`[name="${a}"], #${a}`)?.scrollIntoView({behavior:"smooth",block:"center"});break}},scrollToWizard(){this.$nextTick(()=>{const c=this.$refs.wizard;if(c){const a=c.getBoundingClientRect();(a.top<0||a.top>window.innerHeight*.3)&&c.scrollIntoView({behavior:"smooth",block:"start"})}})},dispatchStepChange(){this.$refs.form?.dispatchEvent(new CustomEvent("wizard:step-change",{bubbles:!0,detail:{currentStep:this.currentStep,totalSteps:this.totalSteps,formHandle:this.formHandle,formId:this.formId}}))}}}return window.formHandler=w,window.formFields=E,window.wizardHandler=F,u.formFields=E,u.formHandler=w,u.wizardHandler=F,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),u})({});
