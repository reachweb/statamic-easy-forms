var EasyForms=(function(f){"use strict";function w(u="formSubmitted",l=null,a=null,h=!1){return{formHandle:u,formId:l||u,recaptchaSiteKey:a,precognitionEnabled:h,submitData:{},errors:{},fatalError:!1,sessionExpired:!1,disableSubmit:!1,successMessage:!1,hasReCaptcha:!!a,isSubmitting:!1,precogForm:null,precogInitialized:!1,init(){this.recaptchaSiteKey&&this.loadReCaptcha()},initPrecognition(){if(typeof this.$form!="function"){this.precognitionEnabled=!1;return}this.precogForm=this.$form("post",this.$refs.form.action,this.submitData),this.precogForm.setValidationTimeout(300),this.precogInitialized=!0,this.$watch("precogForm.errors",s=>{this.errors={...s}})},updateSubmitData(s){this.submitData=s,this.precognitionEnabled&&!this.precogInitialized&&this.initPrecognition(),this.precogForm&&Object.keys(s).forEach(e=>{this.precogForm[e]=s[e]})},validateField(s){!this.precognitionEnabled||!this.precogForm||s==="g-recaptcha-response"||s==="recaptcha"||/\.\d+\./.test(s)||(this.submitData[s]!==void 0&&(this.precogForm[s]=this.submitData[s]),this.precogForm.validate({only:[s]}))},async formSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:submit",{bubbles:!0,detail:{submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}}));try{this.clearErrors(),this.toggleSubmit();let s=null;if(this.recaptchaSiteKey)try{s=await this.getReCaptchaToken()}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:"ReCAPTCHA verification failed. Please refresh the page.",fatalError:!0,formHandle:this.formHandle,formId:this.formId}}));return}const e=this.buildFormData(s),r=await fetch(this.$refs.form.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:e});if(!r.ok){await this.handleErrors(r);return}const t=await r.json();this.handleSuccess(t)}catch(s){this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:s.message,fatalError:!0,formHandle:this.formHandle,formId:this.formId}}))}finally{this.toggleSubmit(),this.isSubmitting=!1}}},buildFormData(s){const e=new FormData;return Object.entries(this.submitData).forEach(([r,t])=>{if(r.startsWith("_grid_count_"))return;const i=r.includes(".")?r.replace(/\.([^.]+)/g,"[$1]"):r;t instanceof FileList?Array.from(t).forEach(o=>e.append(`${i}[]`,o)):t instanceof File?e.append(i,t):Array.isArray(t)?t.forEach(o=>e.append(`${i}[]`,o)):t!=null&&e.append(i,t)}),e.append("_token",this.$refs.form.dataset.csrfToken),s&&e.append("g-recaptcha-response",s),e},toggleSubmit(){this.disableSubmit=!this.disableSubmit},handleSuccess(s){s.success&&(this.successMessage=!0,this.precognitionEnabled&&this.precogForm&&this.precogForm.reset(),this.$refs.form.dispatchEvent(new CustomEvent("form:success",{bubbles:!0,detail:{data:s,submitData:this.submitData,formHandle:this.formHandle,formId:this.formId}})))},async handleErrors(s){try{if(s.status===419)this.sessionExpired=!0;else if(s.status===500)this.fatalError=!0;else{const e=await s.json(),r=e?.error??e?.errors??{};r&&typeof r=="object"&&!Array.isArray(r)?this.errors=Object.fromEntries(Object.entries(r).map(([t,i])=>[t,Array.isArray(i)?i[0]:i])):r?this.errors={form:String(r)}:this.errors={},this.precognitionEnabled&&this.precogForm&&this.precogForm.setErrors(this.errors)}this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:this.errors,status:s.status,fatalError:this.fatalError,sessionExpired:this.sessionExpired,formHandle:this.formHandle,formId:this.formId}})),this.$nextTick(()=>{this.scrollToFirstError()})}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:{},fatalError:!0,sessionExpired:!1,formHandle:this.formHandle,formId:this.formId}}))}},scrollToFirstError(){const s=this.precognitionEnabled&&this.precogForm?this.precogForm.errors:this.errors;if(Object.keys(s).length===0)return;const r=Object.keys(s)[0].replace(/\./g,"_"),t=`${this.formId}_${r}`,i=this.$refs.form.querySelector(`label[for="${t}"]`),o=i?i.closest("div"):this.$refs.form.querySelector(`#${t}`);if(!o)return;const n=o.getBoundingClientRect();n.top>=0&&n.bottom<=window.innerHeight||o.scrollIntoView({behavior:"smooth",block:"center"})},clearErrors(){this.errors={},this.fatalError=!1,this.sessionExpired=!1,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(s=>{this.precogForm.forgetError(s)})},handleGridRowRemoved({handle:s,removedIndex:e}){const r=new RegExp(`^${s}\\.(\\d+)\\.(.+)$`),t={};for(const[i,o]of Object.entries(this.errors)){const n=i.match(r);if(!n){t[i]=o;continue}const c=parseInt(n[1],10);c<e?t[i]=o:c>e&&(t[`${s}.${c-1}.${n[2]}`]=o)}this.errors=t,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(i=>{i.startsWith(`${s}.`)&&this.precogForm.forgetError(i)})},loadReCaptcha(){if(this.recaptchaSiteKey&&!document.querySelector('script[src*="recaptcha"]')){const s=document.createElement("script");s.src=`https://www.google.com/recaptcha/api.js?render=${this.recaptchaSiteKey}`,s.async=!0,s.defer=!0,document.head.appendChild(s)}},getReCaptchaToken(){return new Promise((s,e)=>{if(!this.recaptchaSiteKey){s(null);return}const r=setTimeout(()=>{e(new Error("ReCAPTCHA timeout"))},1e4);let t=0;const i=100,o=()=>{typeof grecaptcha<"u"&&grecaptcha.ready?grecaptcha.ready(()=>{grecaptcha.execute(this.recaptchaSiteKey,{action:"submit"}).then(n=>{clearTimeout(r),s(n)}).catch(n=>{clearTimeout(r),e(n)})}):t++<i?setTimeout(o,100):(clearTimeout(r),e(new Error("ReCAPTCHA failed to load")))};o()})}}}function E(u,l,a,h,s){return{submitFields:{},fields:[],fieldsMap:{},formId:s||"",honeypot:"",hideFields:[],TRACKING_COOKIE_PREFIX:"ef_track_",COOKIE_EXPIRY_DAYS:30,init(){this.honeypot=l,this.hideFields=a||[],this.captureTrackingParams(),this.fields=u.filter(r=>r.input_type!=="hidden").filter(r=>!a.includes(r.handle)),this.submitFields=this.initializeFields(u),this.fieldsMap=u.reduce((r,t)=>(r[t.handle]=t,t.type==="group"&&t.group_fields&&t.group_fields.forEach(i=>{r[i.field_key]=i}),t.type==="grid"&&t.grid_fields&&t.grid_fields.forEach(i=>{r[`${t.handle}._template_.${i.handle}`]=i}),r),{}),h&&Object.keys(h).length>0&&this.loadPrepopulatedData(h);let e;this.$watch("submitFields",r=>{clearTimeout(e),e=setTimeout(()=>{this.$dispatch("fields-changed",this.submitFields)},100)},{deep:!0}),this.$nextTick(()=>{this.$dispatch("fields-changed",this.submitFields)})},shouldShowField(e){let r=this.fieldsMap[e];if(!r){const t=e.replace(/\.(\d+)\./,"._template_.");r=this.fieldsMap[t]}if(!r||this.hideFields.includes(e))return!1;if(!r.if&&!r.unless&&!r.show_when&&!r.hide_when)return!0;try{return typeof window.Statamic>"u"||!window.Statamic?.$conditions?.showField?!0:window.Statamic.$conditions.showField(r,this.submitFields,e)}catch{return!0}},initializeFields(e){return e.reduce((r,t)=>{if(t.type==="group"&&t.group_fields)return t.group_fields.forEach(i=>{const o=`${t.handle}.${i.handle}`;r[o]=this.getFieldDefaultValue(i)}),r;if(t.type==="grid"&&t.grid_fields){let i;if(t.dynamic_rows_field){const o=parseInt(r[t.dynamic_rows_field])||0;i=Math.max(o,t.min_rows||0),t.max_rows&&(i=Math.min(i,t.max_rows))}else i=t.fixed_rows||t.min_rows||1;for(let o=0;o<i;o++)t.grid_fields.forEach(n=>{r[`${t.handle}.${o}.${n.handle}`]=this.getFieldDefaultValue(n)});return r[`_grid_count_${t.handle}`]=i,r}return r[t.handle]=this.getFieldDefaultValue(t),r},{})},getFieldDefaultValue(e){return e.type==="assets"?null:e.type==="toggle"?e.default??!1:e.type==="checkboxes"?e.default||[]:e.handle==="tracking_id"&&e.input_type==="hidden"?this.getTrackingId()||e.default||"":e.default||""},loadPrepopulatedData(e){const r={...this.submitFields};Object.keys(e).forEach(t=>{r.hasOwnProperty(t)&&(r[t]=e[t])}),this.submitFields=r},getTrackingId(){const e=this.getAllTrackingParamsFromUrl(),t={...this.getAllTrackingCookies(),...e};return this.formatTrackingValue(t)},getAllTrackingParamsFromUrl(){const e=this.getTrackedParams(),r=new URLSearchParams(window.location.search),t={};for(const[i,o]of r){const n=i.toLowerCase();e.includes(n)&&o.length<=200&&/^[\w\-_.]+$/.test(o)&&(t[n]=o)}return t},getAllTrackingCookies(){const e={};return this.getTrackedParams().forEach(t=>{const i=this.getCookie(`${this.TRACKING_COOKIE_PREFIX}${t}`);i&&(e[t]=i)}),e},formatTrackingValue(e){const r=Object.entries(e);return r.length===0?"":r.map(([t,i])=>`${encodeURIComponent(t)}=${encodeURIComponent(i)}`).join("&")},getTrackedParams(){const e=["gclid","gbraid","wbraid"],t=this.$el?.closest("form")?.dataset?.trackParams?.split(",").map(i=>i.trim().toLowerCase());return t?.length?t:e},captureTrackingParams(){const e=this.getAllTrackingParamsFromUrl();Object.entries(e).forEach(([r,t])=>{this.setCookie(`${this.TRACKING_COOKIE_PREFIX}${r}`,t,this.COOKIE_EXPIRY_DAYS)})},setCookie(e,r,t){const i=new Date(Date.now()+t*864e5).toUTCString(),o=window.location.protocol==="https:"?"; Secure":"";document.cookie=`${e}=${encodeURIComponent(r)}; expires=${i}; path=/; SameSite=Lax${o}`},getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return t.length===2?decodeURIComponent(t.pop().split(";").shift()):null},addGridRow(e){const r=this.fieldsMap[e];if(!r?.grid_fields)return;const t=`_grid_count_${e}`,i=this.submitFields[t]||0;r.max_rows&&i>=r.max_rows||(r.grid_fields.forEach(o=>{this.submitFields[`${e}.${i}.${o.handle}`]=this.getFieldDefaultValue(o)}),this.submitFields[t]=i+1,this.cloneGridRow(e,i))},removeGridRow(e,r){const t=this.fieldsMap[e];if(!t?.grid_fields)return;const i=`_grid_count_${e}`,o=this.submitFields[i]||0;if(r=parseInt(r),!(t.min_rows&&o<=t.min_rows)){t.grid_fields.forEach(n=>{delete this.submitFields[`${e}.${r}.${n.handle}`]});for(let n=r+1;n<o;n++)t.grid_fields.forEach(c=>{const d=`${e}.${n}.${c.handle}`,p=`${e}.${n-1}.${c.handle}`;this.submitFields[p]=this.submitFields[d],delete this.submitFields[d]});this.submitFields[i]=o-1,this.$dispatch("grid-row-removed",{handle:e,removedIndex:r}),this.rebuildGridRows(e)}},canAddGridRow(e){const r=this.fieldsMap[e];return!r?.grid_fields||r.is_fixed?!1:r.max_rows?(this.submitFields[`_grid_count_${e}`]||0)<r.max_rows:!0},canRemoveGridRow(e){const r=this.fieldsMap[e];if(!r?.grid_fields||r.is_fixed)return!1;const t=r.min_rows||1;return(this.submitFields[`_grid_count_${e}`]||0)>t},cloneGridRow(e,r){const t=this.formId?`${this.formId}_${e}`:e,i=document.querySelector(`[data-grid-template="${t}"]`),o=document.querySelector(`[data-grid-rows="${t}"]`);if(!i||!o)return;const c=i.content.cloneNode(!0).firstElementChild,d=g=>g.replace(/__INDEX__/g,r),p=g=>{const $=[g,...g.querySelectorAll("*")];for(const m of $){for(const b of Array.from(m.attributes||[]))b.value.includes("__INDEX__")&&m.setAttribute(b.name,d(b.value));m.tagName==="TEMPLATE"&&m.content&&p(m.content)}};p(c);const F=c.querySelector(".row-number");F&&(F.textContent=r+1),c.setAttribute("data-grid-row",r),o.appendChild(c)},rebuildGridRows(e){const r=this.formId?`${this.formId}_${e}`:e,t=document.querySelector(`[data-grid-rows="${r}"]`);if(!t)return;t.innerHTML="";const i=this.submitFields[`_grid_count_${e}`]||0;for(let o=0;o<i;o++)this.cloneGridRow(e,o)},setGridRowCount(e,r){const t=this.fieldsMap[e];if(!t?.grid_fields)return;let i=Math.max(parseInt(r)||0,t.min_rows||0);t.max_rows&&(i=Math.min(i,t.max_rows));const o=`_grid_count_${e}`,n=this.submitFields[o]||0;if(i!==n){if(i>n)for(let c=n;c<i;c++)t.grid_fields.forEach(d=>{this.submitFields[`${e}.${c}.${d.handle}`]=this.getFieldDefaultValue(d)});else for(let c=n-1;c>=i;c--)t.grid_fields.forEach(d=>{delete this.submitFields[`${e}.${c}.${d.handle}`]});this.submitFields[o]=i,this.rebuildGridRows(e)}},initDynamicGridRows(e,r){this.$watch(()=>this.submitFields[r],t=>this.setGridRowCount(e,t))}}}function _(u){return{currentStep:1,totalSteps:u,stepValidating:!1,stepFields:{},async goNext(){this.currentStep>=this.totalSteps||this.stepValidating||await this.validateCurrentStep()&&(this.currentStep++,this.scrollToWizard(),this.dispatchStepChange())},goPrev(){this.currentStep>1&&(this.currentStep--,this.scrollToWizard(),this.dispatchStepChange())},getProgressPercent(){return Math.round(this.currentStep/this.totalSteps*100)},hasFieldError(l){if(this.precogForm&&typeof this.precogForm.invalid=="function")return this.precogForm.invalid(l);const a=this.precogForm?.errors?.[l];return a&&(Array.isArray(a)?a.length>0:!0)},async validateCurrentStep(){const l=Array.from(this.stepFields[this.currentStep]||[]);if(l.length===0||!this.precogForm)return!0;this.stepValidating=!0;try{l.forEach(s=>{this.submitData?.[s]!==void 0&&(this.precogForm[s]=this.submitData[s])}),this.precogForm.validate({only:l});let a=0;for(;!this.precogForm.validating&&a<20;)await new Promise(s=>setTimeout(s,50)),a++;for(;this.precogForm.validating;)await new Promise(s=>setTimeout(s,50));return l.some(s=>this.hasFieldError(s))?(this.scrollToFirstError(l),!1):!0}finally{this.stepValidating=!1}},scrollToFirstError(l){if(!l){const a=this.precogForm?.errors||this.errors||{},h=Object.keys(a);if(h.length===0)return;for(let s=1;s<=this.totalSteps;s++){const e=this.stepFields[s]||[];if(e.some(t=>h.includes(t))){this.currentStep=s,this.dispatchStepChange(),this.$nextTick(()=>{this.scrollToFirstError(e)});return}}return}for(const a of l)if(this.hasFieldError(a)){this.$refs.form?.querySelector(`[name="${a}"], #${a}`)?.scrollIntoView({behavior:"smooth",block:"center"});break}},scrollToWizard(){this.$nextTick(()=>{const l=this.$refs.wizard;if(l){const a=l.getBoundingClientRect();(a.top<0||a.top>window.innerHeight*.3)&&l.scrollIntoView({behavior:"smooth",block:"start"})}})},dispatchStepChange(){this.$refs.form?.dispatchEvent(new CustomEvent("wizard:step-change",{bubbles:!0,detail:{currentStep:this.currentStep,totalSteps:this.totalSteps,formHandle:this.formHandle,formId:this.formId}}))}}}return window.formHandler=w,window.formFields=E,window.wizardHandler=_,f.formFields=E,f.formHandler=w,f.wizardHandler=_,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"}),f})({});
