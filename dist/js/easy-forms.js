var EasyForms=(function(c){"use strict";function d(a="formSubmitted",h=null,l=!1){return{formHandle:a,recaptchaSiteKey:h,precognitionEnabled:l,submitData:{},errors:{},fatalError:!1,disableSubmit:!1,successMessage:!1,hasReCaptcha:!!h,isSubmitting:!1,precogForm:null,precogInitialized:!1,validating:!1,touched:{},init(){this.recaptchaSiteKey&&this.loadReCaptcha()},initPrecognition(){if(typeof this.$form!="function"){console.warn("Easy Forms: Precognition is enabled but the laravel-precognition-alpine plugin is not loaded. Load easy-forms-precognition.js to enable precognition support."),this.precognitionEnabled=!1;return}this.precogForm=this.$form("post",this.$refs.form.action,this.submitData),this.precogForm.setValidationTimeout(300),this.precogInitialized=!0,this.$watch("precogForm.errors",t=>{this.errors={...t}})},updateSubmitData(t){this.submitData=t,this.precognitionEnabled&&!this.precogInitialized&&this.initPrecognition(),this.precognitionEnabled&&this.precogForm&&Object.keys(t).forEach(i=>{this.precogForm[i]=t[i]})},validateField(t){!this.precognitionEnabled||!this.precogForm||t==="g-recaptcha-response"||t==="recaptcha"||(this.touched[t]=!0,this.precogForm.validate(t))},isValid(t){return!this.precognitionEnabled||!this.precogForm?!this.errors[t]:this.precogForm.valid(t)},isInvalid(t){return!this.precognitionEnabled||!this.precogForm?!!this.errors[t]:this.precogForm.invalid(t)},isTouched(t){return!!this.touched[t]},getError(t){return this.precognitionEnabled&&this.precogForm?this.precogForm.errors[t]:this.errors[t]},get isValidating(){return this.precognitionEnabled&&this.precogForm?this.precogForm.validating:!1},get hasErrors(){return this.precognitionEnabled&&this.precogForm?this.precogForm.hasErrors:Object.keys(this.errors).length>0},async formSubmit(){if(!this.isSubmitting){this.isSubmitting=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:submit",{bubbles:!0,detail:{submitData:this.submitData,formHandle:this.formHandle}}));try{this.clearErrors(),this.toggleSubmit();let t=null;if(this.recaptchaSiteKey)try{t=await this.getReCaptchaToken()}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:"ReCAPTCHA verification failed. Please refresh the page.",fatalError:!0,formHandle:this.formHandle}}));return}const i=this.buildFormData(t),s=await fetch(this.$refs.form.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:i});if(!s.ok){await this.handleErrors(s);return}const r=await s.json();this.handleSuccess(r)}catch(t){this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{error:t.message,fatalError:!0,formHandle:this.formHandle}}))}finally{this.toggleSubmit(),this.isSubmitting=!1}}},buildFormData(t){const i=new FormData;return Object.entries(this.submitData).forEach(([s,r])=>{r instanceof FileList?Array.from(r).forEach(e=>i.append(`${s}[]`,e)):r instanceof File?i.append(s,r):Array.isArray(r)?r.forEach(e=>i.append(`${s}[]`,e)):r!=null&&i.append(s,r)}),i.append("_token",this.$refs.form.dataset.csrfToken),t&&i.append("g-recaptcha-response",t),i},toggleSubmit(){this.disableSubmit=!this.disableSubmit},handleSuccess(t){t.success&&(this.successMessage=!0,this.precognitionEnabled&&this.precogForm&&(this.precogForm.reset(),this.touched={}),this.$refs.form.dispatchEvent(new CustomEvent("form:success",{bubbles:!0,detail:{data:t,submitData:this.submitData,formHandle:this.formHandle}})))},async handleErrors(t){try{if(t.status===500)this.fatalError=!0;else{const i=await t.json();this.errors=i?.error||i?.errors||{},this.precognitionEnabled&&this.precogForm&&this.precogForm.setErrors(this.errors)}this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:this.errors,status:t.status,fatalError:this.fatalError,formHandle:this.formHandle}})),this.$nextTick(()=>{this.scrollToFirstError()})}catch{this.fatalError=!0,this.$refs.form.dispatchEvent(new CustomEvent("form:error",{bubbles:!0,detail:{errors:{},fatalError:!0,formHandle:this.formHandle}}))}},scrollToFirstError(){const t=this.precognitionEnabled&&this.precogForm?this.precogForm.errors:this.errors;if(Object.keys(t).length===0)return;const i=Object.keys(t)[0],s=this.$refs.form.querySelector(`label[for="${i}"]`),r=s?s.closest("div"):this.$refs.form.querySelector(`#${i}`);if(!r)return;const e=r.getBoundingClientRect();e.top>=0&&e.bottom<=window.innerHeight||r.scrollIntoView({behavior:"smooth",block:"center"})},clearErrors(){this.errors={},this.fatalError=!1,this.precognitionEnabled&&this.precogForm&&Object.keys(this.precogForm.errors).forEach(t=>{this.precogForm.forgetError(t)})},loadReCaptcha(){if(this.recaptchaSiteKey&&!document.querySelector('script[src*="recaptcha"]')){const t=document.createElement("script");t.src=`https://www.google.com/recaptcha/api.js?render=${this.recaptchaSiteKey}`,t.async=!0,t.defer=!0,document.head.appendChild(t)}},getReCaptchaToken(){return new Promise((t,i)=>{if(!this.recaptchaSiteKey){t(null);return}const s=setTimeout(()=>{i(new Error("ReCAPTCHA timeout"))},1e4);let r=0;const e=100,o=()=>{typeof grecaptcha<"u"&&grecaptcha.ready?grecaptcha.ready(()=>{grecaptcha.execute(this.recaptchaSiteKey,{action:"submit"}).then(n=>{clearTimeout(s),t(n)}).catch(n=>{clearTimeout(s),i(n)})}):r++<e?setTimeout(o,100):(clearTimeout(s),i(new Error("ReCAPTCHA failed to load")))};o()})}}}function u(a,h,l,t,i=!1){return{submitFields:{},previousFields:{},fields:[],fieldsMap:{},honeypot:"",precognitionEnabled:i,initialized:!1,init(){this.honeypot=h,this.fields=a.filter(e=>e.input_type!=="hidden").filter(e=>!l.includes(e.handle)),this.submitFields=this.initializeFields(a),this.previousFields=JSON.parse(JSON.stringify(this.submitFields)),this.fieldsMap=a.reduce((e,o)=>({...e,[o.handle]:o}),{}),t&&Object.keys(t).length>0&&this.loadPrepopulatedData(t);let s,r={};this.$watch("submitFields",e=>{clearTimeout(s),s=setTimeout(()=>{this.$dispatch("fields-changed",this.submitFields)},100),this.precognitionEnabled&&this.initialized&&Object.keys(e).forEach(o=>{const n=JSON.stringify(e[o]),m=JSON.stringify(this.previousFields[o]);if(n!==m){const f=this.fieldsMap[o];if(f&&f.type==="assets")return;clearTimeout(r[o]),r[o]=setTimeout(()=>{this.$dispatch("validate-field",o)},300)}}),this.previousFields=JSON.parse(JSON.stringify(e))},{deep:!0}),this.$nextTick(()=>{this.$dispatch("fields-changed",this.submitFields),setTimeout(()=>{this.initialized=!0},100)})},shouldShowField(s){const r=this.fieldsMap[s];if(!r)return!1;try{return typeof window.Statamic>"u"||!window.Statamic?.$conditions?.showField?!0:window.Statamic.$conditions.showField(r,this.submitFields)}catch{return!0}},initializeFields(s){return s.reduce((r,e)=>{let o;return e.type==="assets"?o=null:e.type==="checkboxes"?o=e.default||[]:o=e.default||"",{...r,[e.handle]:o}},{})},loadPrepopulatedData(s){const r={...this.submitFields};Object.keys(s).forEach(e=>{r.hasOwnProperty(e)&&(r[e]=s[e])}),this.submitFields=r}}}return window.formHandler=d,window.formFields=u,c.formFields=u,c.formHandler=d,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),c})({});
